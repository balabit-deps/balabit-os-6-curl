Backport of:

From 1890d59905414ab84a35892b2e45833654aa5c13 Mon Sep 17 00:00:00 2001
From: Dan Fandrich <dan@coneharvesters.com>
Date: Sat, 11 Mar 2017 10:59:34 +0100
Subject: [PATCH] tool_writeout: fixed a buffer read overrun on --write-out

If a % ended the statement, the string's trailing NUL would be skipped
and memory past the end of the buffer would be accessed and potentially
displayed as part of the --write-out output. Added tests 1440 and 1441
to check for this kind of condition.

Reported-by: Brian Carpenter
---
 src/tool_writeout.c     |  2 +-
 tests/data/Makefile.inc |  2 +-
 tests/data/test1440     | 31 +++++++++++++++++++++++++++++++
 tests/data/test1441     | 31 +++++++++++++++++++++++++++++++
 4 files changed, 64 insertions(+), 2 deletions(-)
 create mode 100644 tests/data/test1440
 create mode 100644 tests/data/test1441

Index: curl-7.47.0/src/tool_writeout.c
===================================================================
--- curl-7.47.0.orig/src/tool_writeout.c	2017-10-04 08:50:42.880911816 -0400
+++ curl-7.47.0/src/tool_writeout.c	2017-10-04 08:50:42.876911766 -0400
@@ -107,7 +107,7 @@ void ourWriteOut(CURL *curl, struct OutS
   double doubleinfo;
 
   while(ptr && *ptr) {
-    if('%' == *ptr) {
+    if('%' == *ptr && ptr[1]) {
       if('%' == ptr[1]) {
         /* an escaped %-letter */
         fputc('%', stream);
Index: curl-7.47.0/tests/data/Makefile.inc
===================================================================
--- curl-7.47.0.orig/tests/data/Makefile.inc	2017-10-04 08:50:08.068477006 -0400
+++ curl-7.47.0/tests/data/Makefile.inc	2017-10-04 08:51:04.601182983 -0400
@@ -119,7 +119,7 @@ test1104 test1105 test1106 test1107 test
 test1112 test1113 test1114 test1115 test1116 test1117 test1118 test1119 \
 test1120 test1121 test1122 test1123 test1124 test1125 test1126 test1127 \
 test1128 test1129 test1130 test1131 test1132 test1133 test1134 test1135 \
-test1136 test1137 test1138 \
+test1136 test1137 test1138 test1440 test1441 \
 test1152 \
 \
 test1200 test1201 test1202 test1203 test1204 test1205 test1206 test1207 \
Index: curl-7.47.0/tests/data/test1440
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ curl-7.47.0/tests/data/test1440	2017-10-04 08:50:42.876911766 -0400
@@ -0,0 +1,31 @@
+<testcase>
+<info>
+<keywords>
+--write-out
+</keywords>
+</info>
+# Server-side
+<reply>
+</reply>
+
+# Client-side
+<client>
+<server>
+file
+</server>
+
+<name>
+Check --write-out with trailing %{
+</name>
+<command>
+file://localhost/%PWD/log/ --write-out '%{'
+</command>
+</client>
+
+# Verify data
+<verify>
+<stdout nonewline="yes">
+%{
+</stdout>
+</verify>
+</testcase>
Index: curl-7.47.0/tests/data/test1441
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ curl-7.47.0/tests/data/test1441	2017-10-04 08:50:42.876911766 -0400
@@ -0,0 +1,31 @@
+<testcase>
+<info>
+<keywords>
+--write-out
+</keywords>
+</info>
+# Server-side
+<reply>
+</reply>
+
+# Client-side
+<client>
+<server>
+file
+</server>
+
+<name>
+Check --write-out with trailing %
+</name>
+<command>
+file://localhost/%PWD/log/ --write-out '%'
+</command>
+</client>
+
+# Verify data
+<verify>
+<stdout nonewline="yes">
+%
+</stdout>
+</verify>
+</testcase>
