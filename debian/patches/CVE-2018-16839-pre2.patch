Backport of:

From c1366571b609407cf0d4d9f4a2769d29e1313151 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Tue, 20 Mar 2018 15:15:14 +0100
Subject: [PATCH] vauth/cleartext: fix integer overflow check

Make the integer overflow check not rely on the undefined behavior that
a size_t wraps around on overflow.

Detected by lgtm.com
Closes #2408
---
 lib/curl_ntlm_core.c  | 11 +----------
 lib/curl_setup.h      |  9 +++++++++
 lib/vauth/cleartext.c | 14 ++++----------
 3 files changed, 14 insertions(+), 20 deletions(-)

Index: curl-7.47.0/lib/curl_ntlm_core.c
===================================================================
--- curl-7.47.0.orig/lib/curl_ntlm_core.c	2018-10-24 08:36:12.396102602 -0400
+++ curl-7.47.0/lib/curl_ntlm_core.c	2018-10-24 08:36:54.272090439 -0400
@@ -506,12 +506,6 @@ static void ascii_uppercase_to_unicode_l
 
 #endif /* USE_NTLM_V2 && !USE_WINDOWS_SSPI */
 
-#if defined(SIZEOF_SIZE_T) && (SIZEOF_SIZE_T > 4)
-#define SIZE_T_MAX 18446744073709551615U
-#else
-#define SIZE_T_MAX 4294967295U
-#endif
-
 /*
  * Set up nt hashed passwords
  * @unittest: 1600
Index: curl-7.47.0/lib/curl_setup.h
===================================================================
--- curl-7.47.0.orig/lib/curl_setup.h	2018-10-24 08:36:15.060101545 -0400
+++ curl-7.47.0/lib/curl_setup.h	2018-10-24 08:36:15.060101545 -0400
@@ -416,6 +416,15 @@
 #  endif
 #endif
 
+#ifndef SIZE_T_MAX
+/* some limits.h headers have this defined, some don't */
+#if defined(SIZEOF_SIZE_T) && (SIZEOF_SIZE_T > 4)
+#define SIZE_T_MAX 18446744073709551615U
+#else
+#define SIZE_T_MAX 4294967295U
+#endif
+#endif
+
 /*
  * Arg 2 type for gethostname in case it hasn't been defined in config file.
  */
Index: curl-7.47.0/lib/curl_sasl.c
===================================================================
--- curl-7.47.0.orig/lib/curl_sasl.c	2018-10-24 08:36:15.060101545 -0400
+++ curl-7.47.0/lib/curl_sasl.c	2018-10-24 08:36:15.060101545 -0400
@@ -314,16 +314,10 @@ static CURLcode sasl_create_plain_messag
   ulen = strlen(userp);
   plen = strlen(passwdp);
 
-  /* Compute binary message length, checking for overflows. */
-  plainlen = 2 * ulen;
-  if(plainlen < ulen)
-    return CURLE_OUT_OF_MEMORY;
-  plainlen += plen;
-  if(plainlen < plen)
-    return CURLE_OUT_OF_MEMORY;
-  plainlen += 2;
-  if(plainlen < 2)
+  /* Compute binary message length. Check for overflows. */
+  if((ulen > SIZE_T_MAX/2) || (plen > (SIZE_T_MAX/2 - 2)))
     return CURLE_OUT_OF_MEMORY;
+  plainlen = 2 * ulen + plen + 2;
 
   plainauth = malloc(plainlen);
   if(!plainauth)
